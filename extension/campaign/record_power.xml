<?xml version="1.0" encoding="UTF-8"?>
<root>
	<windowclass name="power_item" merge="join">
		<script>
			function onInit()
				if super and super.onInit then
					super.onInit();
				end

				if not windowlist.isReadOnly() then
					registerMenuItem(Interface.getString("power_menu_addtransfer"), "radial_transfer", 3, 6);
				end
			end

			function onMenuSelection(selection, subselection)
				if super and super.onMenuSelection then
					super.onMenuSelection(selection, subselection);
				end

				if selection == 3 then
					if subselection == 6 then
						createAction("transfer");
						activatedetail.setValue(1);
					end
				end
			end
		</script>
	</windowclass>
	
	<windowclass name="power_action" merge="join">
		<script>
			function onInit()
				if super and super.onInit then
					super.onInit();
				end
				
				local sNode = getDatabaseNode().getPath();
				DB.addHandler(sNode, "onChildUpdate", onDataChanged);
				onDataChanged();
			end

			function onClose()
				if super and super.onClose then
					super.onClose();
				end

				local sNode = getDatabaseNode().getPath();
				DB.removeHandler(sNode, "onChildUpdate", onDataChanged);
			end

			function updateDisplay()
				if super and super.updateDisplay then
					super.updateDisplay();
				end

				local node = getDatabaseNode();
				local sType = DB.getValue(node, "type", "");
				local bShowTransfer = (sType == "transfer");

				transferbutton.setVisible(bShowTransfer);
				transferlabel.setVisible(bShowTransfer);
				transferview.setVisible(bShowTransfer);
				transferdetail.setVisible(bShowTransfer);
			end

			function onDataChanged()
				if super and super.onDataChanged then
					super.onDataChanged();
				end

				local sType = DB.getValue(getDatabaseNode(), "type", "");
				if sType == "transfer" then
					onTransferChanged();
				end
			end

			function onTransferChanged()
				local sTransfer = PowerManagerCA.getPCPowerTransferActionText(getDatabaseNode());
				transferview.setValue(sTransfer);
			end
		</script>
		<sheetdata>
			<button_poweraction name="transferbutton">
				<anchored position="insidetopleft" offset="2,2" />
				<icon normal="button_action_damage" pressed="button_action_damage_down" />
			</button_poweraction>
			<label name="transferlabel">
				<anchored to="transferbutton" position="righthigh" offset="5,0" width="35" />
				<static textres="power_label_tfr" />
			</label>
			<string_poweractionview name="transferview">
				<anchored to="transferlabel" position="righthigh" offset="20,0">
					<right parent="" offset="-55" />
				</anchored>
			</string_poweractionview>
			<button_poweractioneditor name="transferdetail">
				<editor>power_transfer_editor</editor>
			</button_poweractioneditor>
		</sheetdata>
	</windowclass>
</root>